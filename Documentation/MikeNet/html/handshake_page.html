<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>DarkNet: Server/Client Handshake</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javaScript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body onload='searchBox.OnSelectItem(0);'>
<!-- Generated by Doxygen 1.7.1 -->
<script type="text/javascript"><!--
var searchBox = new SearchBox("searchBox", "search",false,'Search');
--></script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Classes</span></a></li>
      <li><a href="files.html"><span>Files</span></a></li>
      <li id="searchli">
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<h1>Server/Client Handshake </h1>  </div>
</div>
<div class="contents">
<p>This page explains exactly what happens when a client attempts to connect to the server, and the impact that disabling the TCP handshake will have.<br/>
<br/>
</p>
<h2><a class="anchor" id="handshakeProcess"></a>
The Process</h2>
<p>The below process is implemented by <a class="el" href="class_net_instance_client.html" title="Client instance, designed to communicate with servers.">NetInstanceClient</a> and <a class="el" href="class_net_instance_server.html" title="Server instance, designed to communicate with clients.">NetInstanceServer</a>. <br/>
<br/>
</p>
<p>size_t is either a 32 bit unsigned integer or a 64 bit unsigned integer depending on which build of the API you are using. If you are running the 32 bit version, 4 bytes of padding are added after each 32 bit size_t meaning that there are always 64 bits in a size_t. This ensures that all builds of the API can operate together.<br/>
<br/>
</p>
<h3><a class="anchor" id="handshakeProcessActual"></a>
Process</h3>
<ul>
<li>Client attempts to connect to server via TCP.<br/>
</li>
</ul>
<ul>
<li>Client is rejected if the server is full.</li>
<li>If the client is accepted, it is sent a TCP packet from the server which contains:<ul>
<li>size_t: Maximum number of clients that can be connected to server.</li>
<li>size_t: Number of UDP operations (only if UDP is enabled).</li>
<li>signed char: UDP mode (only if UDP is enabled).</li>
<li>size_t: Client ID of newly connected client.</li>
<li>int: Authentication code (only if UDP is enabled).</li>
<li>int: Authentication code (only if UDP is enabled).</li>
<li>int: Authentication code (only if UDP is enabled).</li>
<li>int: Authentication code (only if UDP is enabled).<br/>
</li>
</ul>
</li>
</ul>
<ul>
<li>Client receives packet.</li>
<li>If UDP is disabled is the client is now fully connected and the connection process is over.</li>
<li>If UDP is enabled the process continues as follows.<br/>
</li>
</ul>
<ul>
<li>Client sends UDP packet to server. The purpose of this packet is to traverse the client's NAT and validate the UDP connection. The client repeatedly sends this packet to avoid problems with packet loss. It contains:<ul>
<li>size_t: Prefix of 0 indicating the packet's purpose.</li>
<li>size_t: Client's client ID.</li>
<li>int: Authentication code.</li>
<li>int: Authentication code.</li>
<li>int: Authentication code.</li>
<li>int: Authentication code.<br/>
<br/>
</li>
</ul>
</li>
</ul>
<ul>
<li>Server receives UDP packet.</li>
<li>If the client was not validated successfully the server forcefully disconnects the client.</li>
<li>If the client is validated successfully then in order to signal that the connection process is over and tell the client that it can stop sending the UDP packet the server sends a TCP packet to the client containing no data (except for the prefix indicating a length of 0).</li>
</ul>
<ul>
<li>If at any point in this process either the server's connection timeout expires or the client's timeout expires then the connection process is aborted.<br/>
<br/>
</li>
</ul>
<h2><a class="anchor" id="handshakeSecurity"></a>
Security</h2>
<h3><a class="anchor" id="handshakeSecurityAuthentication"></a>
Authentication</h3>
<p>Authentication codes are random integers generated by the server and are used to prevent malicious activity in the following example:</p>
<ul>
<li>Normal client begins connecting and finalizes TCP connection.</li>
<li>Server is now waiting for UDP packet which may come from a different IP or port to the TCP connection.</li>
<li>Malicious client sends UDP packet to server attempting to hijack normal client's connection.<br/>
</li>
</ul>
<p>In this example malicious client only needs to guess the client ID if there are no authentication codes. With authentication codes however, it is near impossible for a malicious client to hijack a connection in this way.<br/>
<br/>
</p>
<h3><a class="anchor" id="handshakeSecurityConnectionTimeout"></a>
Connection Timeout</h3>
<p>If the server is spammed with connection attempts that never complete it would eventually throw an error due to running out of memory.</p>
<p>From the moment that a client first communicates with the server, it is allowed a set amount of time to complete the handshaking process before the process is aborted and the client is forcefully silently disconnected.<br/>
<br/>
</p>
<h2><a class="anchor" id="handshakeDisable"></a>
Impact of disabling handshake</h2>
<p>Disabling the handshake process has the following impact:</p>
<ul>
<li>All UDP commands will fail.</li>
<li>Clients will be unable to retrieve the following using in built methods/commands:<ul>
<li>Their client ID.</li>
<li>The maximum number of clients that can be connected to the server. </li>
</ul>
</li>
</ul>
</div>
<!--- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&nbsp;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&nbsp;</span>Classes</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&nbsp;</span>Namespaces</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&nbsp;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&nbsp;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&nbsp;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&nbsp;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&nbsp;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&nbsp;</span>Friends</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<hr class="footer"/><address class="footer"><small>Generated on Sat Sep 25 2010 22:10:16 for DarkNet by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.7.1 </small></address>
</body>
</html>
